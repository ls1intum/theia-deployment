# ==============================================================================
# PR Deployment Workflow
# ==============================================================================
# This workflow handles deployments triggered by pull requests and manual
# selections via the GitHub Actions UI.
# ==============================================================================

name: Deploy PR to Environment

on:
  # Automatic trigger on PR events
  pull_request:
    types: [opened, synchronize, reopened]

  # Manual trigger via GitHub UI
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to deploy to"
        required: true
        type: choice
        options:
          - test1
          - test2
          - test3
      theia_cloud_tag:
        description: 'Theia Cloud components tag (operator, service, landing-page)'
        required: false
        default: 'latest'
      ide_images_tag:
        description: 'IDE images tag (appdefinitions and preloading)'
        required: false
        default: 'latest'

jobs:
  # Job 1: Deploy to Test1 environment
  # Runs automatically on all PR events OR when manually selected
  # Environment variables NAMESPACE and HELM_VALUES_PATH are read from GitHub Environment settings
  deploy-test1:
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'test1')
    name: Deploy to Test1
    uses: ./.github/workflows/deploy-theia.yml
    with:
      environment: test1
      theia_cloud_tag: ${{ inputs.theia_cloud_tag || 'latest' }}
      ide_images_tag: ${{ inputs.ide_images_tag || 'latest' }}
    secrets: inherit

  # Job 2: Deploy to Test2 environment
  # Runs automatically on all PR events OR when manually selected
  # Environment variables NAMESPACE and HELM_VALUES_PATH are read from GitHub Environment settings
  deploy-test2:
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'test2')
    name: Deploy to Test2
    uses: ./.github/workflows/deploy-theia.yml
    with:
      environment: test2
      theia_cloud_tag: ${{ inputs.theia_cloud_tag || 'latest' }}
      ide_images_tag: ${{ inputs.ide_images_tag || 'latest' }}
    secrets: inherit

  # Job 3: Deploy to Test3 environment
  # Runs automatically on all PR events OR when manually selected
  # Environment variables NAMESPACE and HELM_VALUES_PATH are read from GitHub Environment settings
  deploy-test3:
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'test3')
    name: Deploy to Test3
    uses: ./.github/workflows/deploy-theia.yml
    with:
      environment: test3
      theia_cloud_tag: ${{ inputs.theia_cloud_tag || 'latest' }}
      ide_images_tag: ${{ inputs.ide_images_tag || 'latest' }}
    secrets: inherit