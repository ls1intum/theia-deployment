# ==============================================================================
# Reusable Workflow: Deploy Theia Cloud
# ==============================================================================
# This is the core deployment workflow that handles the actual Helm installation
# of Theia Cloud to any environment. It's designed to be reusable and is called
# by other workflows (deploy-pr.yml, deploy-staging.yml, deploy-production.yml).
#
# Purpose:
#   - Install/upgrade Theia Cloud Helm charts to a specific Kubernetes namespace
#   - Handle environment-specific configuration via Helm values
#   - Manage secrets for certificates and Keycloak authentication
#
# Usage:
#   This workflow should not be triggered directly. It's called by other workflows
#   using the workflow_call trigger.
#
# Required Secrets (configured per GitHub Environment):
#   - KUBECONFIG: Kubernetes cluster configuration
#   - THEIA_WILDCARD_CERTIFICATE_CERT: SSL certificate (base64 encoded)
#   - THEIA_WILDCARD_CERTIFICATE_KEY: SSL certificate key (base64 encoded)
#   - THEIA_KEYCLOAK_COOKIE_SECRET: OAuth2 proxy cookie secret
#   - THEIA_KEYCLOAK_REALM: Keycloak realm name
#   - THEIA_KEYCLOAK_CLIENT_ID: Keycloak client ID
#   - THEIA_KEYCLOAK_CLIENT_SECRET: Keycloak client secret
#
# Parameters:
#   - environment: GitHub environment name (e.g., prod, staging, test1)
#
# Required Environment Variables (configured per GitHub Environment):
#   - NAMESPACE: Target Kubernetes namespace
#   - HELM_VALUES_PATH: Path to environment-specific Helm values directory
# ==============================================================================

name: Deploy Theia Cloud

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (e.g., prod, staging, test1)"
        required: true
        type: string
      theia_cloud_tag:
        description: "Image tag for Theia Cloud components (operator, service, landing-page)"
        required: false
        type: string
        default: "latest"
      ide_images_tag:
        description: "Image tag for IDE images (appdefinitions and preloading)"
        required: false
        type: string
        default: "latest"
      helm_chart_branch:
        description: "Branch of theia-cloud-helm to use (leave empty for main/published)"
        required: false
        type: string
        default: ""

jobs:
  helm-install:
    name: Install Theia Cloud Helm Chart
    permissions:
      contents: read
    runs-on: arc-runner-set-stateless
    # Link to GitHub Environment for secrets and protection rules
    environment: ${{ inputs.environment }}

    steps:
      # Step 1: Checkout the repository to access Helm charts and values
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Helm CLI (v3.14.0)
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      # Step 2.5: Install kubectl (not pre-installed on self-hosted runners)
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      # Step 3: Configure kubectl to connect to the target Kubernetes cluster
      # The KUBECONFIG secret contains the cluster connection configuration
      - name: Setup Kubeconfig
        run: |
          # Write kubeconfig from secret to file
          echo "${{ secrets.KUBECONFIG }}" > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          chmod 600 kubeconfig

          # Verify connection to cluster
          kubectl config get-contexts
          kubectl get nodes

      # Step 3.5: Checkout upstream Helm chart branch if specified
      - name: Checkout Upstream Helm Branch
        if: inputs.helm_chart_branch != ''
        uses: actions/checkout@v4
        with:
          repository: ls1intum/theia-cloud-helm
          ref: ${{ inputs.helm_chart_branch }}
          path: upstream-helm

      # Step 3.6: Patch Chart.yaml to use local upstream chart
      - name: Patch Chart.yaml
        if: inputs.helm_chart_branch != ''
        run: |
          echo "Patching Chart.yaml to use local upstream chart from branch: ${{ inputs.helm_chart_branch }}"
          
          # Remove Chart.lock to force fresh dependency resolution
          rm -f ./charts/theia-cloud-combined/Chart.lock
          
          # Get the version from the local upstream chart
          UPSTREAM_VERSION=$(grep '^version:' ./upstream-helm/charts/theia-cloud/Chart.yaml | head -1 | awk '{print $2}')
          echo "Detected upstream chart version: $UPSTREAM_VERSION"
          
          # Patch the repository URL to use local file path
          sed -i 's|repository: "https://ls1intum.github.io/theia-cloud-helm"|repository: "file://../../upstream-helm/charts/theia-cloud"|' ./charts/theia-cloud-combined/Chart.yaml
          sed -i 's|repository: "https://eclipse-theia.github.io/theia-cloud-helm/"|repository: "file://../../upstream-helm/charts/theia-cloud"|' ./charts/theia-cloud-combined/Chart.yaml
          sed -i 's|repository: "https://eclipse-theia.github.io/theia-cloud-helm"|repository: "file://../../upstream-helm/charts/theia-cloud"|' ./charts/theia-cloud-combined/Chart.yaml
          
          # Patch the version to match the local chart's version exactly
          sed -i "/name: theia-cloud/{n;s/version: .*/version: $UPSTREAM_VERSION/}" ./charts/theia-cloud-combined/Chart.yaml
          
          echo "Patched Chart.yaml content:"
          cat ./charts/theia-cloud-combined/Chart.yaml

      # Step 4: Install Theia Cloud base components, CRDs, and cluster-wide monitoring
      # These are prerequisites from the upstream Theia Cloud Helm repository
      - name: Setup Helm dependencies
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          # Add upstream Theia Cloud Helm repository
          helm repo add theia-cloud-repo https://eclipse-theia.github.io/theia-cloud-helm/
          helm repo update

          # Update dependencies for our custom chart
          helm dependency update ./charts/theia-cloud-combined

          # Install base components (operator base, metrics, etc.)
          helm upgrade theia-cloud-base theia-cloud-repo/theia-cloud-base --install -f ${{ vars.HELM_VALUES_PATH }}/theia-base-helm-values.yml

          # Install Custom Resource Definitions (CRDs) for Theia Cloud
          helm upgrade theia-cloud-crds theia-cloud-repo/theia-cloud-crds --install -f ${{ vars.HELM_VALUES_PATH }}/theia-crds-helm-values.yml

          # Install cluster-wide monitoring (PodMonitors + Grafana Dashboards)
          # This is installed once per cluster, not per environment
          helm upgrade theia-monitoring ./charts/theia-monitoring --install

      # Step 5: Install the main Theia Cloud application with environment-specific configuration
      # This includes the operator, service, certificates, and app definitions
      - name: Install Theia Cloud in namespace ${{ vars.NAMESPACE }}
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          # Prepare SSL certificates for ingress
          # Note: Secrets are already base64 encoded, but we need to write them to files
          echo "${{ secrets.THEIA_WILDCARD_CERTIFICATE_CERT }}" | base64 -w 0 > wildcard.crt
          echo "${{ secrets.THEIA_WILDCARD_CERTIFICATE_KEY }}" | base64 -w 0 > wildcard.key

          # Define image tag variables for cleaner command
          THEIA_CLOUD_TAG="${{ inputs.theia_cloud_tag }}"
          IDE_IMAGES_TAG="${{ inputs.ide_images_tag }}"

          # Install/upgrade the Helm chart with all configuration
          # --install: Create if it doesn't exist, upgrade if it does
          # --create-namespace: Create the namespace if it doesn't exist
          # Image tags controlled by two variables: THEIA_CLOUD_TAG and IDE_IMAGES_TAG
          helm upgrade --install theia-cloud-combined ./charts/theia-cloud-combined \
            --namespace ${{ vars.NAMESPACE }} \
            --create-namespace \
            -f ${{ vars.HELM_VALUES_PATH }}/values.yaml \
            --set theia-certificates.wildcardCertificate="$(cat wildcard.crt)" \
            --set theia-certificates.wildcardKey="$(cat wildcard.key)" \
            --set theia-cloud.keycloak.cookieSecret="${{ secrets.THEIA_KEYCLOAK_COOKIE_SECRET }}" \
            --set theia-cloud.landingPage.image="ghcr.io/ls1intum/theia/landing-page:${THEIA_CLOUD_TAG}" \
            --set theia-cloud.operator.image="ghcr.io/ls1intum/theia/operator:${THEIA_CLOUD_TAG}" \
            --set theia-cloud.service.image="ghcr.io/ls1intum/theia/service:${THEIA_CLOUD_TAG}" \
            --set "theia-cloud.preloading.images[0]=ghcr.io/ls1intum/theia/landing-page:${THEIA_CLOUD_TAG}" \
            --set "theia-cloud.preloading.images[1]=ghcr.io/ls1intum/theia/java-17:${IDE_IMAGES_TAG}" \
            --set "theia-cloud.preloading.images[2]=ghcr.io/ls1intum/theia/c:${IDE_IMAGES_TAG}" \
            --set "theia-cloud.preloading.images[3]=ghcr.io/ls1intum/theia/javascript:${IDE_IMAGES_TAG}" \
            --set "theia-cloud.preloading.images[4]=ghcr.io/ls1intum/theia/ocaml:${IDE_IMAGES_TAG}" \
            --set "theia-cloud.preloading.images[5]=ghcr.io/ls1intum/theia/rust:${IDE_IMAGES_TAG}" \
            --set "theia-cloud.preloading.images[6]=ghcr.io/ls1intum/theia/python:${IDE_IMAGES_TAG}" \
            --set theia-appdefinitions.defaultImageTag="${IDE_IMAGES_TAG}"
