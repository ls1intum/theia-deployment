# ==============================================================================
# Reusable Workflow: Deploy Theia Cloud
# ==============================================================================
# This is the core deployment workflow that handles the actual Helm installation
# of Theia Cloud to any environment. It's designed to be reusable and is called
# by other workflows (deploy-pr.yml, deploy-staging.yml, deploy-production.yml).
#
# Purpose:
#   - Install/upgrade Theia Cloud Helm charts to a specific Kubernetes namespace
#   - Handle environment-specific configuration via Helm values
#   - Manage secrets for certificates and Keycloak authentication
#
# Usage:
#   This workflow should not be triggered directly. It's called by other workflows
#   using the workflow_call trigger.
#
# Required Secrets (configured per GitHub Environment):
#   - KUBECONFIG: Kubernetes cluster configuration
#   - THEIA_WILDCARD_CERTIFICATE_CERT: SSL certificate (base64 encoded)
#   - THEIA_WILDCARD_CERTIFICATE_KEY: SSL certificate key (base64 encoded)
#   - THEIA_KEYCLOAK_COOKIE_SECRET: OAuth2 proxy cookie secret
#   - THEIA_KEYCLOAK_REALM: Keycloak realm name
#   - THEIA_KEYCLOAK_CLIENT_ID: Keycloak client ID
#   - THEIA_KEYCLOAK_CLIENT_SECRET: Keycloak client secret
#
# Parameters:
#   - environment: GitHub environment name (e.g., theia-prod, theia-staging)
#   - namespace: Target Kubernetes namespace
#   - helm_values_path: Path to environment-specific Helm values directory
# ==============================================================================

name: Deploy Theia Cloud

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (e.g., theia-prod, theia-staging, theia-test1)'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace to deploy to'
        required: true
        type: string
      helm_values_path:
        description: 'Path to environment-specific Helm values (e.g., deployments/theia.artemis.cit.tum.de)'
        required: true
        type: string

jobs:
  helm-install:
    name: Install Theia Cloud Helm Chart
    permissions:
      contents: read
    runs-on: ubuntu-latest
    # Link to GitHub Environment for secrets and protection rules
    environment: ${{ inputs.environment }}

    steps:
      # Step 1: Checkout the repository to access Helm charts and values
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Helm CLI (v3.14.0)
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      # Step 3: Configure kubectl to connect to the target Kubernetes cluster
      # The KUBECONFIG secret contains the cluster connection configuration
      - name: Setup Kubeconfig
        run: |
          # Write kubeconfig from secret to file
          echo "${{ secrets.KUBECONFIG }}" > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          chmod 600 kubeconfig

          # Verify connection to cluster
          kubectl config get-contexts
          kubectl get nodes

      # Step 4: Install Theia Cloud base components and CRDs
      # These are prerequisites from the upstream Theia Cloud Helm repository
      - name: Setup Helm dependencies
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          # Add upstream Theia Cloud Helm repository
          helm repo add theia-cloud-repo https://eclipse-theia.github.io/theia-cloud-helm/
          helm repo update

          # Update dependencies for our custom chart
          helm dependency update ./charts/theia-cloud-combined

          # Install base components (operator base, metrics, etc.)
          helm upgrade theia-cloud-base theia-cloud-repo/theia-cloud-base --install -f ${{ inputs.helm_values_path }}/theia-base-helm-values.yml

          # Install Custom Resource Definitions (CRDs) for Theia Cloud
          helm upgrade theia-cloud-crds theia-cloud-repo/theia-cloud-crds --install -f ${{ inputs.helm_values_path }}/theia-crds-helm-values.yml

      # Step 5: Install the main Theia Cloud application with environment-specific configuration
      # This includes the operator, service, certificates, and app definitions
      - name: Install Theia Cloud in namespace ${{ inputs.namespace }}
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          # Prepare SSL certificates for ingress
          # Note: Secrets are already base64 encoded, but we need to write them to files
          echo "${{ secrets.THEIA_WILDCARD_CERTIFICATE_CERT }}" | base64 -w 0 > wildcard.crt
          echo "${{ secrets.THEIA_WILDCARD_CERTIFICATE_KEY }}" | base64 -w 0 > wildcard.key

          # Install/upgrade the Helm chart with all configuration
          # --install: Create if it doesn't exist, upgrade if it does
          # --create-namespace: Create the namespace if it doesn't exist
          helm upgrade --install theia-cloud-combined ./charts/theia-cloud-combined \
            --namespace ${{ inputs.namespace }} \
            --create-namespace \
            -f ${{ inputs.helm_values_path }}/values.yaml \
            --set theia-certificates.wildcardCertificate="$(cat wildcard.crt)" \
            --set theia-certificates.wildcardKey="$(cat wildcard.key)" \
            --set theia-cloud.keycloak.cookieSecret="${{ secrets.THEIA_KEYCLOAK_COOKIE_SECRET }}" \
            --set theia-cloud.keycloak.realm="${{ secrets.THEIA_KEYCLOAK_REALM }}" \
            --set theia-cloud.keycloak.clientId="${{ secrets.THEIA_KEYCLOAK_CLIENT_ID }}" \
            --set theia-cloud.keycloak.clientSecret="${{ secrets.THEIA_KEYCLOAK_CLIENT_SECRET }}"
